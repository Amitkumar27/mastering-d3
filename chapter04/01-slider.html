<!DOCTYPE html>
<html>

    <head>
        <title>4.1 Slider</title>
        <link rel="stylesheet" href="../css/bootstrap.min.css">
        <link rel="stylesheet" href="../css/mastering-d3.css">
        <script src="../js/lib/d3.v3.min.js" charset="utf-8"></script>
    </head>

    <body>
        <div class="container">

            <h1>4.1 Creating a Slider</h1>

            <!-- Table of Contents -->
            <h2>Contents</h2>

            <ul class="list-unstyled toc-list">
                <li><a href="#drag">Drag Behavior</a></li>
                <li><a href="#slider">Creating a Slider</a></li>
                <li><a href="#using">Using the Slider</a></li>
            </ul>


            <section>
                <h2><a href="#drag" name="drag">#</a> Drag Behavior</h2>

                <div class="chart-example" id="chart01"></div>

                <script>
                    // Width and height of the figure.
                    var width = 600,
                        height = 150;

                    // Create the svg element.
                    var svg = d3.select('#chart01').append('svg')
                        .attr('width', width)
                        .attr('height', height);

                    // Append a grey circle in the middle.
                    var circle = svg.append('circle')
                        .attr('cx', width / 2)
                        .attr('cy', height / 2)
                        .attr('r', 30)
                        .attr('fill', '#555');

                    // Create and configure a drag behavior.
                    var drag = d3.behavior.drag()
                        .on('drag', dragListener);

                    // Add dragging handling to the circle.
                    circle.call(drag);

                    // Moves the circle on drag.
                    function dragListener(d) {
                        // Get the current position of the circle.
                        var cx = +d3.select(this).attr('cx'),
                            cy = +d3.select(this).attr('cy');

                        // Set the new position of the circle.
                        d3.select(this)
                            .attr('cx', cx + d3.event.dx)
                            .attr('cy', cy + d3.event.dy);
                    }
                </script>
            </section>


            <section>
                <h2><a href="#slider" name="slider">#</a> Creating a Slider</h2>

                <!-- Container of the chart -->
                <div class="chart-example" id="chart02"></div>

                <script>

                    // Slider Control
                    // --------------

                    function sliderControl() {

                        // Slider Attributes

                        // Slider width.
                        var width = 600;

                        // Default domain.
                        var domain = [0, 100];

                        // Default slider callback.
                        var onSlide = function(selection) { };

                        // Charting function.
                        function chart(selection) {
                            selection.each(function(data) {

                                // Select the container group.
                                var group = d3.select(this);

                                // Add a line covering the complete width.
                                group.selectAll('line')
                                    .data([data])
                                    .enter()
                                    .append('line')
                                    .call(chart.initLine);

                                // Append a circle as handler.
                                var handler = group.selectAll('circle')
                                    .data([data])
                                    .enter()
                                    .append('circle')
                                    .call(chart.initHandle);

                                // Set the position scale.
                                var posScale = d3.scale.linear()
                                    .domain(domain)
                                    .range([0, width]);

                                // Create and configure the drag behavior.
                                var drag = d3.behavior.drag()
                                    .on('drag', moveHandler);

                                // Set the position of the circle and adds the drag behavior.
                                handler
                                    .attr('cx', function(d) { return posScale(d); })
                                    .call(drag);

                                function moveHandler(d) {
                                    // Compute the future position of the handler
                                    var cx = +d3.select(this).attr('cx') + d3.event.dx;

                                    // Update the position if its within its valid range.
                                    if ((0 < cx) && (cx < width)) {
                                        // Compute the new value and rebind the data
                                        d3.select(this)
                                            .data([posScale.invert(cx)])
                                            .attr('cx', cx)
                                            .call(onSlide);
                                    }
                                }
                            });
                        }

                        // Set the initial attributes of the line.
                        chart.initLine = function(selection) {
                            selection
                                .attr('x1', 0)
                                .attr('x2', width)
                                .attr('stroke', '#555')
                                .attr('stroke-width', 6)
                                .attr('stroke-linecap', 'round');
                        };

                        // Set the initial attributes of the handle.
                        chart.initHandle = function(selection) {
                            selection
                                .attr('cx', function(d) { return width / 2; })
                                .attr('r', 8)
                                .attr('fill', '#aaa')
                                .attr('stroke', '#222')
                                .attr('stroke-width', 2);
                        };

                        // Accessor Methods

                        // Width
                        chart.width = function(value) {
                            if (!arguments.length) { return width; }
                            width = value;
                            return chart;
                        };

                        // Domain
                        chart.domain = function(value) {
                            if (!arguments.length) { return domain; }
                            domain = value;
                            return chart;
                        };

                        // Slide callback function
                        chart.onSlide = function(onSlideFunction) {
                            if (!arguments.length) { return onSlide; }
                            onSlide = onSlideFunction;
                            return chart;
                        };

                        return chart;
                    }

                    // Figure properties.
                    var width = 600,
                        height = 60,
                        margin = 20;

                    // Create the svg element and set its dimensions.
                    var svg = d3.select('#chart02').append('svg')
                        .attr('width', width + 2 * margin)
                        .attr('height', height + 2 * margin);

                    // Valid range and initial value.
                    var value = 70,
                        domain = [0, 100];

                    // Create and configure the slider control.
                    var slider = sliderControl()
                        .width(width)
                        .domain(domain);

                    // Set a simple callback for the slide event.
                    slider.onSlide(function(selection) {
                        selection.each(function(d) {
                            console.log('value = ' + d);
                        });
                    });

                    // Create a container for the slider and translate it
                    // to align it vertically.
                    var gSlider = svg.selectAll('g')
                        .data([value])
                        .enter()
                        .append('g')
                        .attr('transform', 'translate(' + [margin, height / 2] + ')')
                        .call(slider);
                </script>
            </section>


            <section>
                <h2><a href="#using" name="using">#</a> Using the Slider</h2>

                <div class="chart-example" id="chart03"></div>

                <script>
                    // Chart Settings
                    var width = 600,
                        height = 40,
                        margin = 15;

                    // Initial value
                    var domain = [0, 100],
                        value = 35;

                    // Create the svg element
                    var svg = d3.select('#chart03').append('svg')
                        .attr('width', width + 2 * margin)
                        .attr('height', height + 3 * margin);

                    // Create a color scale with the same range that the slider
                    var cScale = d3.scale.linear()
                        .domain(domain)
                        .range(['#edd400', '#a40000']);

                    // Add a background to the svg element.
                    var rectangle = svg.append('rect')
                        .attr('x', margin)
                        .attr('y', 2 * margin)
                        .attr('width', width)
                        .attr('height', height)
                        .attr('fill', cScale(value));

                    // Create and configure the slider control.
                    var slider = sliderControl()
                        .domain(domain)
                        .width(width)
                        .onSlide(function(selection) {
                            selection.each(function(d) {
                                rectangle.attr('fill', cScale(d));
                            });
                        });

                    // Create a group to hold the slider and add the slider to it.
                    var gSlider = svg.selectAll('g')
                        .data([value])
                        .enter()
                        .append('g')
                        .attr('transform', 'translate(' + [margin, margin] + ')')
                        .call(slider);
                </script>

            </section>

            <div style="height: 150px;"></div>

        </div>
    </body>
</html>